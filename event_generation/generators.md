FCC: Getting started with event generation
===================================================================================

## Enabling FCCSW

The FCC software `FCCSW` is fully embedded in the `key4hep` software stack or ecosystem, which means that the components providing the FCC-specific framework are all available in `key4hep`. To configure your environment for the FCC software, it is therefore sufficient to initialise `key4hep`:

```
source /cvmfs/sw.hsf.org/key4hep/setup.sh
```

The steering application `k4run` should be available at this point:

```bash
which k4run
```

The output should not be empty, and have a structure similar to the following:

```bash
$ /cvmfs/sw.hsf.org/spackages7/k4fwcore/1.0pre16/x86_64-centos7-gcc11.2.0-opt/tp4u6/bin/k4run
```
(The output might differ, but shouldn't be empty and the structure should be similar.)

The application `fccrun` is fully equivalent to `k4run`.

## Generators

### Overview

The physics generators available for FCC usually come from `key4hep`. However, any generator
able to generate events in one of the understood formats, e.g. HepMC, EDM4hep, or LHEf, can be used standalone.
Several generators, integrated in key4hep, can be used, but here we will only generate events using Pythia8 and Whizard.

###  Pythia8

Pythia8 is fully integrated in `key4hep` software stack, and it provides diverse functionality in addition to event generation. Here, we'll only use it for event generation

Pythia8 can be run using a Gaudi steering file, which interfaces `Pythia8`, and a Pythia8 configuration file, usually having extension `.cmd`. The steering file runs the minimal set of algorithms to run Pythia8 and produce an output in `EDM4hep` format.


To generate 500 e<sup>+</sup>e<sup>-</sup> &#8594; mu<sup>+</sup>mu<sup>-</sup> at 91.2 GeV, download the steering file and the corresponding configuration file:
```
mkdir -p fcc_tutorial/generator/Pythia8 && cd fcc_tutorial/generator/Pythia8
wget https://raw.githubusercontent.com/HEP-FCC/k4Gen/main/k4Gen/options/pythia.py
wget https://raw.githubusercontent.com/HEP-FCC/FCC-config/main/FCCee/Generator/Pythia8/p8_ee_Zmumu_ecm91.cmd
```

Then the events can be generated by simply running:
```
k4run pythia.py -n 500 --out.filename p8_mumu_500_e4h.root --Pythia8.PythiaInterface.pythiacard p8_ee_Zmumu_ecm91.cmd
```

###  Whizard

Whizard is available as standalone program. Test is by running:

```bash
which whizard
```

The output should have the follwoing form:

``` bash
$ /cvmfs/sw.hsf.org/spackages6/whizard/3.0.3/x86_64-centos7-gcc11.2.0-opt/yy7yk/bin/whizard
```

Whizard is run using Sindarin configuration files, example of which can be found under:

``` bash
ls /cvmfs/sw.hsf.org/spackages6/whizard/3.0.3/x86_64-centos7-gcc11.2.0-opt/yy7yk/share/whizard/examples/
```
or at [https://gitlab.tp.nt.uni-siegen.de/whizard/public/-/tree/master/share/examples](https://gitlab.tp.nt.uni-siegen.de/whizard/public/-/tree/master/share/examples).

Some examples more specific to FCC can be found at [https://fccsw.web.cern.ch/fccsw/share/gen/whizard/Zpole/](https://fccsw.web.cern.ch/fccsw/share/gen/whizard/Zpole/)`.

Before generating events using Whizard, let's move back to the parent directory. It is advised to work in a separate directory for each process. So, for this example, we move to:

```bash
 cd ..
 mkdir -p Whizard/Z_mumu; cd Whizard/Z_mumu
```

Now, let's download the Sindarin configuration file to generate 100 e<sup>+</sup>e<sup>-</sup> &#8594; mu<sup>+</sup>mu<sup>-</sup>(gamma) events:

```bash
 wget https://fccsw.web.cern.ch/fccsw/share/gen/whizard/Zpole/Z_mumu.sin
```

In order to change output format from LHEf to HepMC3 one needs to comment-out
last two lines of the Sindarin configuration file and comment-in HepMC3
configuration line:
```diff
< # simulate (zmumu) { $sample = "z_mumu" sample_format = hepmc }
---
> simulate (zmumu) { $sample = "z_mumu" sample_format = hepmc }

.
.
.

< $lhef_version = "3.0"
< simulate (zmumu) { $sample = "z_mumu" sample_format = lhef }
---
> # $lhef_version = "3.0"
> # simulate (zmumu) { $sample = "z_mumu" sample_format = lhef }
```

Now we can generate events by running:

```bash
 whizard Z_mumu.sin
```

Whizard output log:

```
| Writing log to 'whizard.log'
|=============================================================================|
|                                                                             |
|    WW             WW  WW   WW  WW  WWWWWW      WW      WWWWW    WWWW        |
|     WW    WW     WW   WW   WW  WW     WW      WWWW     WW  WW   WW  WW      |
|      WW  WW WW  WW    WWWWWWW  WW    WW      WW  WW    WWWWW    WW   WW     |
|       WWWW   WWWW     WW   WW  WW   WW      WWWWWWWW   WW  WW   WW  WW      |
|        WW     WW      WW   WW  WW  WWWWWW  WW      WW  WW   WW  WWWW        |
|                                                                             |
|                                                                             |

...

|=============================================================================|
|                               WHIZARD 3.0.1
|=============================================================================|
| Reading model file '/cvmfs/sw.hsf.org/spackages6/whizard/3.0.1/x86_64-centos7-gcc11.2.0-opt/pmm4s/share/whizard/models/SM.mdl'
| Preloaded model: SM
| Process library 'default_lib': initialized
| Preloaded library: default_lib
| Reading model file '/cvmfs/sw.hsf.org/spackages6/whizard/3.0.1/x86_64-centos7-gcc11.2.0-opt/pmm4s/share/whizard/models/SM_hadrons.mdl'
| Reading commands from file 'Z_mumu.sin'
| Switching to model 'SM', scheme 'default'

...

$description = "A WHIZARD 3.0 Example.
   Z -> mumu @ 91.2 events for FCC ee."
$y_label = "$N_{\textrm{events}}$"
$sample = "z_mumu"
| Starting simulation for process 'zmumu'
| Simulate: using integration grids from file 'zmumu.m1.vg'
| RNG: Initializing TAO random-number generator
| RNG: Setting seed for random-number generator to 22345
| Simulation: requested number of events = 1000
|             corr. to luminosity [fb-1] =   6.6285E-04
| Events: writing to HepMC file 'z_mumu.hepmc'
| Events: writing to raw file 'z_mumu.evx'
| Events: generating 1000 unweighted, unpolarized events ...
| Events: event normalization mode '1'
|         ... event sample complete.
| Events: actual unweighting efficiency =   1.16 %
Warning: Encountered events with excess weight: 6 events (  0.600 %)
| Maximum excess weight = 2.465E+00
| Average excess weight = 4.511E-03
| Events: closing HepMC file 'z_mumu.hepmc'
| Events: closing raw file 'z_mumu.evx'
| There were no errors and    2 warning(s).
| WHIZARD run finished.
|=============================================================================|
```
